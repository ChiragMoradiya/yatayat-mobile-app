<!-- App Layout Elements -->
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-styles/paper-styles.html">
<!-- <link rel="import" href="../bower_components/app-route/app-location.html"> -->
<!-- <link rel="import" href="../bower_components/app-route/app-route.html"> -->
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">

<!-- Paper Elements -->
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<!--  Firebase -->
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<!-- Iron Elements -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-meta/iron-meta.html">
<link rel="import" href="../bower_components/iron-localstorage/iron-localstorage.html">
<link rel="import" href="../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/iron-form/iron-form.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../bower_components/iron-signals/iron-signals.html">
<!-- Gold Elements -->
<link rel="import" href="../bower_components/gold-email-input/gold-email-input.html">

<!-- Iron Elements -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">

<!-- custom elements -->
<link rel="import" href="common/vehicle-location-notifier-behavior.html">
<link rel="import" href="common/fields-service.html">
<link rel="import" href="yatayat-login.html">
<link rel="import" href="user-registration-page.html">
<link rel="import" href="event-page.html">
<link rel="import" href="vehicle-registration-page.html">
<link rel="import" href="journey-page.html">
<link rel="import" href="common/vehicle-status-update-service.html">

<!-- Shared Dependencies -->
<link rel="import" href="shared-dependencies/yatayat-styles.html">

<dom-module id="mobile-app">
  <template>
    <style include="yatayat-styles iron-flex iron-positioning">
      
      :host {
        display: block;
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
      }

      app-header {
        background-color: var(--app-primary-color);
        color: #fff;
      }
      app-header paper-icon-button {
        --paper-icon-button-ink-color: white;
      }

      .drawer-list {
        margin: 0 20px;
      }
      .drawer-list a {
        display: block;
        padding: 0 16px;
        line-height: 40px;
        text-decoration: none;
        color: var(--app-secondary-color);
      }
      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }
      .drawer-list a.subroute {
        padding-left: 32px;
      }
    </style>
      <iron-meta key="appConfig" value="{{appConfig}}"></iron-meta>
      <iron-meta key="apiBaseUrl" value="{{appConfig.apiBaseUrl}}"></iron-meta>
      <iron-meta-query key="apiBaseUrl" value="{{test}}"></iron-meta-query>
      <iron-localstorage  name="vehicleId" value="{{vehicleId}}"
        on-iron-localstorage-load-empty="_vehicleIdNotAvailable"  ></iron-localstorage>
      <firebase-app auth-domain="{{appConfig.firebase.authDomain}}"
        database-url="[[appConfig.firebase.databaseURL]]"
        api-key="[[appConfig.firebase.apiKey]]">
      </firebase-app>
      <firebase-document path="/activeEvent" data="{{event}}"></firebase-document>
      <firebase-document path="{{_vehiclePath(event,vehicleId)}}" data="{{vehicle}}"></firebase-document>
      
      <iron-ajax url="{{_locationAjaxURL}}" id="locationAjax"
        method="POST" content-type="application/json"
        body="{{_locationReqBody}}"
      ></iron-ajax>
      <vehicle-status-update-service vehicle="{{vehicle}}"></vehicle-status-update-service>
      <iron-signals on-iron-signal-navigate="_navigate"></iron-signals>
<!--       <app-location id="location" route="{{route}}"></app-location> -->
<!--       <app-route -->
<!--           route="{{route}}" -->
<!--           pattern="/:page" -->
<!--           data="{{routeData}}" -->
<!--           tail="{{subroute}}"></app-route> -->
      <app-drawer-layout fullbleed>
  
        <!-- Drawer content -->
        <app-drawer hidden>
          <app-toolbar>Menu</app-toolbar>
          <iron-selector selected="[[page]]" attr-for-selected="name" class="drawer-list" role="navigation">
<!--             <a name="userRegistration" href="/userRegistration">User Registration</a> -->
            <a name="event" href="/event">Event</a>
            <a name="vehicleRegistration" href="/vehicleRegistration">Vehicle Registration</a>
            <a name="journey" href="/journey">Journey</a>
          </iron-selector>
        </app-drawer>
  
        <!-- Main content -->
        <paper-header-panel mode="seamed">
  
          <paper-toolbar>
              <paper-icon-button icon="menu" drawer-toggle hidden></paper-icon-button>
              <div title class="title">Yatayat</div>
          </paper-toolbar>
  
          <iron-pages role="main" selected="[[page]]" attr-for-selected="name" selected-attribute="active" id="pages" class="fit layout vertical">
<!--             <yatayat-login name="login" class="flex"></yatayat-login> -->
<!--             <user-registration-page name="userRegistration" class="flex"></user-registration-page> -->
            <event-page name="event" class="flex" event="{{event}}" vehicle="{{vehicle}}"></event-page>
            <vehicle-registration-page name="vehicleRegistration" class="flex" event="{{event}}"></vehicle-registration-page>
            <journey-page name="journey" class="flex" event="{{event}}" vehicle="{{vehicle}}"></journey-page>
          </iron-pages>
  
        </paper-header-panel>
  
      </app-drawer-layout>
  </template>

  <script>
  (function() {
    var appConfig = {
      apiBaseUrl : 'http://mitulg.0.dream-world.in:8585/api',
      firebase: {
        apiKey: "AIzaSyDrobo53HxXq4SFQGzb_rochvTMEcjwHpE",
        authDomain: "yatayat-ee219.firebaseapp.com",
        databaseURL: "https://yatayat-ee219.firebaseio.com",
        storageBucket: "yatayat-ee219.appspot.com",
      },
      //Default interval at which app will send location to the server, 
      //It's used when event.refreshInterval isn't specified
      defaultLocationNotificationInterval: 5
    };
    
    Polymer({

      is: 'mobile-app',

      properties: {

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },
        
        appConfig : {
          type: Object,
          value: appConfig
        },
        
        event: {
          type: Object,
        },
        
        vehicle: {
          type: Object,
        },
        
        vehicleId: {
          type: String
        }
      },

      observers: [
        '_routePageChanged(routeData.page)',
        '_defaultPage(event.status, vehicleId)',
        '_defaultPage(event.status, vehicleId, vehicle.*)',
      ],
      
      attached: function() {
        this._defaultPage();
      },

      _routePageChanged: function(page) {
        this.page = page || undefined;
      },
      
      _defaultPage:  function(eventStatus, vehicleId) {
        var vehicleStatus = this.vehicle.status;
        var vehicleApproved = this.vehicle.isApproved;
        console.log(eventStatus, vehicleId, vehicleStatus, vehicleApproved);
        
        //If page is already set, no need to set default page
        if(this.page) {
          return;
        }
        
        //Wait if vehicle data is yet to be loaded.
        if(vehicleId !== null && vehicleApproved === undefined) {
          return;
        }
        
        if(eventStatus === 'CLOSED') {
          return;
        }
        
        if((eventStatus === 'TRANSIT_FORWARD' || eventStatus === 'TRANSIT_BACKWARD') 
                && vehicleApproved 
                && (vehicleStatus !== 'REGISTERED' && vehicleStatus !== 'ARRIVED')) {
          this.set('page', 'journey');
        } else {
          this.set('page', 'event');
        }
      },
      
      _pageChanged: function(page) {
        // load page import on demand.
//         this.importHref(
//           this.resolveUrl('my-' + page + '.html'), null, null, true);
      },
      
      _vehicleIdNotAvailable: function(){
//         this.set('vehicleId', 'vehicle-1');
        console.log('vehicleId not available');
      },
      
      _vehiclePath: function(event, vehicleId) {
        if(!event.id) {
          return;
        }
        return '/events/' + event.id + '/vehicles/' + vehicleId;
      },
      
      _navigate: function(e) {
        this.set('page', e.detail.path);
//         this.$.location.set('route.path', e.detail.path);
      },
      
      behaviors: [window.yatayat.VehicleLocationNotifierBehavior]

    });
  })();
  </script>
</dom-module>
